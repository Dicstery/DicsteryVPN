<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dicstery VPN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        :root {
            --bg-dark: #0a0c14;
            --bg-card: #141824;
            --bg-card-hover: #1e2230;
            --accent-primary: #4a6cf7;
            --accent-secondary: #6b8aff;
            --accent-glow: rgba(74, 108, 247, 0.4);
            --vip-primary: #f1c40f;
            --vip-secondary: #f39c12;
            --vip-glow: rgba(241, 196, 15, 0.4);
            --text-primary: #ffffff;
            --text-secondary: #8f9bb3;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --border-radius: 24px;
            --border-radius-sm: 16px;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px var(--accent-glow);
            --transition: all 0.3s ease;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 20px;
            position: relative;
        }

        .watermark {
            position: fixed;
            bottom: 10px;
            right: 10px;
            opacity: 0.3;
            font-size: 12px;
            color: var(--text-secondary);
            pointer-events: none;
            z-index: 9999;
            transform: rotate(-5deg);
        }

        .app-header {
            background: linear-gradient(135deg, #1a1f2f, #0f1320);
            padding: 25px 20px 15px;
            text-align: center;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #a5b9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }

        .support-link {
            color: var(--accent-secondary);
            text-decoration: none;
            font-size: 14px;
            margin-top: 5px;
            display: inline-block;
        }

        .support-link:hover {
            color: var(--accent-primary);
        }

        .container {
            padding: 0 16px;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            animation: fadeInUp 0.5s ease;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .card:hover {
            background: var(--bg-card-hover);
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .info-value {
            font-weight: 600;
            font-size: 16px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .status-vip {
            background: linear-gradient(135deg, rgba(241, 196, 15, 0.15), rgba(243, 156, 18, 0.15));
            color: var(--vip-primary);
            border: 1px solid var(--vip-primary);
        }

        .status-expired {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .status-admin {
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.15), rgba(142, 68, 173, 0.15));
            color: #9b59b6;
            border: 1px solid #9b59b6;
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 14px 20px;
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            box-shadow: 0 4px 15px rgba(74, 108, 247, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 108, 247, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border: none;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.5);
        }

        .btn-vip {
            background: linear-gradient(135deg, var(--vip-primary), var(--vip-secondary));
            border: none;
            box-shadow: 0 4px 15px var(--vip-glow);
            color: #000;
        }

        .btn-vip:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--vip-glow);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent-primary);
        }

        .btn-outline:hover {
            background: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .server-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .server-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 18px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
            position: relative;
        }

        .server-item:hover {
            background: rgba(74, 108, 247, 0.1);
            border-color: var(--accent-primary);
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(74, 108, 247, 0.2);
        }

        .vip-server {
            border: 1px solid var(--vip-primary);
        }

        .vip-server:hover {
            background: rgba(241, 196, 15, 0.1);
            border-color: var(--vip-primary);
            box-shadow: 0 0 20px var(--vip-glow);
        }

        .server-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .server-flag {
            font-size: 28px;
            flex-shrink: 0;
        }

        .server-details {
            flex: 1;
            min-width: 0;
        }

        .server-name {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
        }

        .server-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--vip-primary);
            color: #000;
            white-space: nowrap;
        }

        .server-host {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ping-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .ping-bar {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .ping-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .ping-value {
            font-size: 11px;
            color: var(--text-secondary);
            min-width: 35px;
        }

        .connect-btn {
            background: transparent;
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
            margin-left: 8px;
        }

        .connect-btn:hover {
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 14px;
            border-radius: 30px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .filter-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .filter-btn.vip-filter {
            border-color: var(--vip-primary);
            color: var(--vip-primary);
        }
        
        .filter-btn.vip-filter.active {
            background: var(--vip-primary);
            color: black;
        }

        .subscription-info {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }

        .info-block {
            text-align: center;
        }

        .info-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .info-label-small {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .expired-message {
            text-align: center;
            padding: 30px;
            color: var(--danger);
            font-size: 18px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        @media (max-width: 380px) {
            .filter-bar {
                gap: 5px;
            }
            .filter-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            .connect-btn {
                padding: 4px 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="watermark">@Dicstery</div>

    <div class="app-header">
        <div class="app-title">‚ö° DICSTERY VPN</div>
        <a href="https://t.me/Dicstery" class="support-link">@Dicstery</a>
    </div>

    <div class="container" id="mainContainer">
        <div id="expiredMessage" style="display: none;" class="card expired-message">
            ‚ùå –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –∏—Å—Ç–µ–∫<br>
            <small>–ü—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ –±–æ—Ç–µ @DicsteryVPN_bot</small>
        </div>

        <div id="content" style="display: block;">
            <div class="card" id="profileCard">
                <div class="card-title">
                    <span>üë§</span> –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                </div>
                <div class="info-row">
                    <span class="info-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    <span class="info-value" id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–°—Ç–∞—Ç—É—Å</span>
                    <span class="info-value"><span class="status-badge" id="statusBadge">ACTIVE</span></span>
                </div>
                <div class="subscription-info">
                    <div class="info-block">
                        <div class="info-number" id="daysLeft">30</div>
                        <div class="info-label-small">–¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å</div>
                    </div>
                    <div class="info-block">
                        <div class="info-number" id="gbLeft">50</div>
                        <div class="info-label-small">–ì–ë –æ—Å—Ç–∞–ª–æ—Å—å</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span>üìä</span> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç—Ä–∞—Ñ–∏–∫–∞
                </div>
                <div class="info-row">
                    <span class="info-label" id="trafficUsedLabel">0 GB / 50 GB</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="trafficBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span>üñ•</span> –°–µ—Ä–≤–µ—Ä–∞
                </div>
                <div class="filter-bar" id="serverFilters">
                    <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
                    <button class="filter-btn" data-filter="RU">üá∑üá∫</button>
                    <button class="filter-btn" data-filter="GB">üá¨üáß</button>
                    <button class="filter-btn" data-filter="FR">üá´üá∑</button>
                    <button class="filter-btn" data-filter="US">üá∫üá∏</button>
                    <button class="filter-btn" data-filter="NL">üá≥üá±</button>
                    <button class="filter-btn" data-filter="SE">üá∏üá™</button>
                    <button class="filter-btn" data-filter="JP">üáØüáµ</button>
                    <button class="filter-btn" data-filter="IT">üáÆüáπ</button>
                    <button class="filter-btn" data-filter="DE">üá©üá™</button>
                    <button class="filter-btn vip-filter" data-filter="vip">üëë VIP</button>
                </div>
                <div class="server-list" id="serverList">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success action-btn" onclick="addAllServers()">
                        <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ
                    </button>
                    <button class="btn btn-primary action-btn" onclick="copySubscriptionLink()">
                        <span>üìã</span> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://dicstery-vpn.fly.dev';
        
        function getTelegramID() {
            if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
                return Telegram.WebApp.initDataUnsafe.user.id;
            }
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('user_id') || '7383521067';
        }

        const TELEGRAM_ID = getTelegramID();

        let userData = {
            username: '–ó–∞–≥—Ä—É–∑–∫–∞...',
            status: 'ACTIVE',
            is_admin: false,
            subscription_end: new Date(Date.now() + 30*24*60*60*1000).toISOString(),
            subscription_type: 'basic',
            traffic_used: 0,
            traffic_limit: 50 * 1024
        };

        let servers = [];
        let currentFilter = 'all';
        let isActive = true;

        function checkSubscription() {
            fetch(`${API_URL}/api/user/subscription/status?id=${TELEGRAM_ID}`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        if (data.error === "Subscription expired") {
                            showExpired();
                        }
                        return;
                    }
                    
                    isActive = data.is_active;
                    userData.is_admin = data.is_admin || false;
                    
                    if (!isActive && !userData.is_admin) {
                        showExpired();
                    } else {
                        document.getElementById('expiredMessage').style.display = 'none';
                        document.getElementById('content').style.display = 'block';
                        fetchUserData();
                        fetchServers();
                    }
                })
                .catch(() => {
                    fetchUserData();
                    fetchServers();
                });
        }

        function showExpired() {
            document.getElementById('expiredMessage').style.display = 'block';
            document.getElementById('content').style.display = 'none';
        }

        function fetchUserData() {
            fetch(`${API_URL}/api/user/info?id=${TELEGRAM_ID}`)
                .then(r => r.json())
                .then(data => {
                    if (data && !data.error) {
                        userData = { ...userData, ...data };
                        updateUI();
                    }
                })
                .catch(() => {
                    userData.username = 'user_' + TELEGRAM_ID.toString().slice(-4);
                    updateUI();
                });
        }

        function fetchServers() {
            fetch(`${API_URL}/api/servers/detailed?user_id=${TELEGRAM_ID}`)
                .then(r => r.json())
                .then(data => {
                    if (data.servers) {
                        servers = data.servers.map(s => ({
                            ...s,
                            ping: Math.floor(Math.random() * 100) + 20
                        }));
                        sortServersByPing();
                        renderServers();
                    }
                })
                .catch(() => {
                    servers = [
                        {id: 1, name: 'üá∑üá∫ Russia #1', location: 'RU', host: '212.192.14.234', port: 24441, protocol: 'shadowsocks', method: 'chacha20-ietf-poly1305', password: 'Ow8iSExQNaobZPY9bJ4EPI', ping: 23, vip_only: false},
                        {id: 2, name: 'üá∑üá∫ Russia #2', location: 'RU', host: '62.113.114.116', port: 42320, protocol: 'shadowsocks', method: 'chacha20-ietf-poly1305', password: 'BShcek5ydlWbXEnhl2vlym', ping: 45, vip_only: false},
                        {id: 3, name: 'üá∑üá∫ Russia #3', location: 'RU', host: 'spb.scroogethebest.com', port: 443, protocol: 'vless', uuid: 'ccedb1b1-35f3-46d1-a85a-c699eef5f3e1', flow: 'xtls-rprx-vision', security: 'reality', network: 'tcp', tls: 'reality', sni: 'spb.scroogethebest.com', fingerprint: 'chrome', public_key: 'C3hc32Cknec2shasKJIH2DYVb7Fyu64RF9v71L3ipEg', short_id: '9c2378562188c3cb', ping: 18, vip_only: false},
                        {id: 4, name: 'üá¨üáß UK #1', location: 'GB', host: 'series-a1.samanehha.co', port: 443, protocol: 'shadowsocks', method: 'chacha20-ietf-poly1305', password: 'W74XFALLLuw6m5IA', ping: 78, vip_only: false},
                        {id: 5, name: 'üá¨üáß UK #2', location: 'GB', host: 'admin.c2.havij.co', port: 443, protocol: 'shadowsocks', method: 'chacha20-ietf-poly1305', password: 'kaQH3hGdcP80XEDI', ping: 82, vip_only: false},
                        {id: 6, name: 'üá´üá∑ France', location: 'FR', host: '95.111.250.4', port: 80, protocol: 'shadowsocks', method: 'aes-256-gcm', password: 'BbOUgNLUyT6rdrxE', ping: 67, vip_only: false},
                        {id: 7, name: 'üá∫üá∏ USA', location: 'US', host: '154.38.176.7', port: 80, protocol: 'shadowsocks', method: 'aes-256-gcm', password: 'nKeE2ZFWVaE4DyjR', ping: 145, vip_only: false},
                        {id: 8, name: 'üá≥üá± Netherlands', location: 'NL', host: '82.38.31.62', port: 8080, protocol: 'shadowsocks', method: 'chacha20-ietf-poly1305', password: 'oZloA69Q8yhcQV8ka3Pa3A', ping: 56, vip_only: false},
                        {id: 9, name: 'üá∏üá™ Sweden', location: 'SE', host: '46.246.97.140', port: 53908, protocol: 'shadowsocks', method: 'chacha20-ietf-poly1305', password: 'ZweuXavjovuhzt1AF0d6qx', ping: 62, vip_only: false},
                        {id: 10, name: 'üáØüáµ Japan', location: 'JP', host: '103.106.228.175', port: 8009, protocol: 'shadowsocks', method: 'aes-256-gcm', password: 'XKFKI2rULjlP74', ping: 185, vip_only: false},
                        {id: 11, name: 'üáÆüáπ Italy VIP', location: 'IT', host: '80.211.133.156', port: 443, protocol: 'vless', uuid: 'd443fb54-207c-4fa4-b9d8-3ae2a2957532', flow: 'xtls-rprx-vision', security: 'reality', network: 'tcp', tls: 'reality', sni: 'gmail.com', fingerprint: 'chrome', alpn: 'h2', public_key: 'ckRcueERkPqqjZABwxqni_J_Nbb70Q6k5fEEUAjoImw', ping: 58, vip_only: true},
                        {id: 12, name: 'üá©üá™ Germany #2 VIP', location: 'DE', host: '93.94.51.13', port: 25451, protocol: 'vless', uuid: 'a90f4742-2f30-47b5-9f17-b6ab04cc98e8', security: 'reality', network: 'tcp', tls: 'reality', sni: 'yandex.ru', fingerprint: 'chrome', public_key: 'JlMOb8hVg1VOrRlMLdXpv8IADp-R4I-cIT856hz_Cg0', short_id: 'f686d19cd7b8b3df', ping: 32, vip_only: true},
                        {id: 13, name: 'üá©üá™ Germany #3 VIP', location: 'DE', host: 'deu469.unboundworld.org', port: 8443, protocol: 'vless', uuid: 'cc9f7840-757a-430b-bddc-a73478bea434', security: 'tls', network: 'grpc', tls: 'tls', sni: 'deu469.unboundworld.org', fingerprint: 'chrome', alpn: 'h2', allow_insecure: true, grpc_service_name: 'grpc-vless', ping: 41, vip_only: true},
                        {id: 14, name: 'üá©üá™ Germany #4 VIP', location: 'DE', host: '81.19.141.190', port: 51529, protocol: 'vless', uuid: 'ad2879c1-7f77-4a4c-ba50-c24dd5ceffa4', security: 'reality', network: 'tcp', tls: 'reality', sni: 'yandex.ru', fingerprint: 'chrome', public_key: '9smFk5QZXifHGrtwDwhbROsLBh179bExNWABnvUCvSw', short_id: 'b77a294515ecc200', ping: 28, vip_only: true}
                    ];
                    sortServersByPing();
                    renderServers();
                });
        }

        function sortServersByPing() {
            servers.sort((a, b) => a.ping - b.ping);
        }

        function renderServers() {
            const container = document.getElementById('serverList');
            container.innerHTML = '';
            
            let filteredServers = currentFilter === 'all' 
                ? servers 
                : currentFilter === 'vip'
                    ? servers.filter(s => s.vip_only)
                    : servers.filter(s => s.location === currentFilter);
            
            filteredServers.forEach(server => {
                const pingColor = server.ping < 40 ? '#2ecc71' : server.ping < 80 ? '#f39c12' : '#e74c3c';
                const pingPercent = Math.min(100, (server.ping / 200) * 100);
                const isVip = server.vip_only;
                
                const serverEl = document.createElement('div');
                serverEl.className = `server-item ${isVip ? 'vip-server' : ''}`;
                
                let protocolIcon = '';
                if (server.protocol === 'vless') protocolIcon = 'üîÆ';
                else if (server.protocol === 'shadowsocks') protocolIcon = '‚ö°';
                
                serverEl.innerHTML = `
                    <div class="server-info">
                        <span class="server-flag">${server.name.split(' ')[0]}</span>
                        <div class="server-details">
                            <div class="server-name">
                                ${server.name}
                                ${isVip ? '<span class="server-badge">VIP</span>' : ''}
                                <span style="font-size: 12px; margin-left: 4px;">${protocolIcon}</span>
                            </div>
                            <div class="server-host">${server.host}:${server.port}</div>
                            <div class="ping-bar-container">
                                <div class="ping-bar">
                                    <div class="ping-fill" style="width: ${pingPercent}%; background: ${pingColor};"></div>
                                </div>
                                <span class="ping-value">${server.ping} ms</span>
                            </div>
                        </div>
                    </div>
                    <button class="connect-btn" onclick="addSingleServer(${server.id})">‚ûï</button>
                `;
                container.appendChild(serverEl);
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    renderServers();
                });
            });
        }

        function generateServerLink(server) {
            if (server.protocol === 'shadowsocks') {
                const ssString = `${server.method}:${server.password}`;
                const ssBase64 = btoa(ssString);
                return `ss://${ssBase64}@${server.host}:${server.port}#${server.name}`;
            } else if (server.protocol === 'vless') {
                let params = [
                    `type=${server.network || 'tcp'}`,
                    `security=${server.tls || 'none'}`
                ];
                if (server.tls === 'reality') {
                    if (server.public_key) params.push(`pbk=${server.public_key}`);
                    if (server.sni) params.push(`sni=${server.sni}`);
                    if (server.fingerprint) params.push(`fp=${server.fingerprint}`);
                    if (server.short_id) params.push(`sid=${server.short_id}`);
                }
                if (server.flow) params.push(`flow=${server.flow}`);
                if (server.network === 'grpc') {
                    if (server.grpc_service_name) params.push(`serviceName=${server.grpc_service_name}`);
                    params.push(`mode=gun`);
                }
                if (server.alpn) params.push(`alpn=${server.alpn}`);
                if (server.allow_insecure) params.push(`allowInsecure=1`);
                
                const paramsStr = params.join('&');
                return `vless://${server.uuid}@${server.host}:${server.port}?${paramsStr}#${server.name}`;
            }
            return '';
        }

        function generateSubscriptionLink() {
            const serverLinks = servers.map(s => generateServerLink(s)).filter(l => l).join('\n');
            const daysLeft = calculateDaysLeft();
            const gbLeft = calculateGBLeft();
            const adminMark = userData.is_admin ? 'üëë –ê–¥–º–∏–Ω' : '';
            const watermark = `\n\nüìÖ –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: ${daysLeft}\nüìä –û—Å—Ç–∞–ª–æ—Å—å –ì–ë: ${gbLeft}\nü§ñ –ë–æ—Ç: @DicsteryVPN_bot\nüë§ –ü–æ–¥–¥–µ—Ä–∂–∫–∞: @Dicstery ${adminMark}`;
            return serverLinks + watermark;
        }

        function addSingleServer(serverId) {
            const server = servers.find(s => s.id === serverId);
            if (!server) return;
            
            const link = generateServerLink(server);
            navigator.clipboard.writeText(link).then(() => {
                alert(`‚úÖ –ö–æ–Ω—Ñ–∏–≥ ${server.name} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!`);
            });
        }

        function addAllServers() {
            const fullLink = generateSubscriptionLink();
            navigator.clipboard.writeText(fullLink).then(() => {
                alert('‚úÖ –í—Å–µ —Å–µ—Ä–≤–µ—Ä–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!\n–í—Å—Ç–∞–≤—å—Ç–µ –≤ Happ –∏ –ø–æ–¥–ø–∏—Å–∫–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
            });
        }

        function copySubscriptionLink() {
            const fullLink = generateSubscriptionLink();
            navigator.clipboard.writeText(fullLink).then(() => {
                alert('‚úÖ –°—Å—ã–ª–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            });
        }

        function calculateDaysLeft() {
            if (userData.is_admin) return '‚àû';
            if (!userData.subscription_end) return 0;
            const end = new Date(userData.subscription_end);
            const now = new Date();
            const diff = end - now;
            return Math.max(0, Math.floor(diff / (1000 * 60 * 60 * 24)));
        }

        function calculateGBLeft() {
            if (userData.is_admin) return '‚àû';
            if (userData.traffic_limit === 0) return '‚àû';
            const usedGB = userData.traffic_used / 1024;
            const limitGB = userData.traffic_limit / 1024;
            return (limitGB - usedGB).toFixed(1);
        }

        function updateUI() {
            document.getElementById('username').innerText = userData.username;
            
            const daysLeft = calculateDaysLeft();
            const gbLeft = calculateGBLeft();
            
            document.getElementById('daysLeft').innerText = daysLeft;
            document.getElementById('gbLeft').innerText = gbLeft;
            
            const statusBadge = document.getElementById('statusBadge');
            if (userData.is_admin) {
                statusBadge.innerText = 'ADMIN';
                statusBadge.className = 'status-badge status-admin';
            } else if (userData.status === 'VIP') {
                statusBadge.innerText = 'VIP';
                statusBadge.className = 'status-badge status-vip';
            } else if (userData.status === 'ACTIVE') {
                statusBadge.innerText = 'ACTIVE';
                statusBadge.className = 'status-badge status-active';
            } else {
                statusBadge.innerText = 'EXPIRED';
                statusBadge.className = 'status-badge status-expired';
            }
            
            const usedGB = (userData.traffic_used / 1024).toFixed(1);
            const limitGB = userData.traffic_limit === 0 || userData.is_admin ? '‚àû' : (userData.traffic_limit / 1024).toFixed(1);
            
            document.getElementById('trafficUsedLabel').innerText = `${usedGB} GB / ${limitGB} GB`;
            
            if (userData.traffic_limit > 0 && !userData.is_admin) {
                const percent = (userData.traffic_used / userData.traffic_limit) * 100;
                document.getElementById('trafficBar').style.width = `${percent}%`;
            } else {
                document.getElementById('trafficBar').style.width = '0%';
            }
        }

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        checkSubscription();
        setInterval(checkSubscription, 30000);
        setInterval(() => {
            servers = servers.map(s => ({
                ...s, 
                ping: Math.floor(Math.random() * 100) + 20
            }));
            sortServersByPing();
            renderServers();
        }, 10000);
    </script>
</body>
</html>